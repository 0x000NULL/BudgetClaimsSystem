<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Claim - Budget Claims System</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <header>
        <!-- Logo and navigation -->
        <img src="/images/Budget_logo.svg" alt="Budget Logo" class="logo">
        <h1>Budget Claims System</h1>
        <nav>
            <ul>
                <li><a href="/dashboard">Dashboard</a></li> <!-- Link to Dashboard -->
                <li class="Claims">
                    <a href="javascript:void(0)" class="dropbtn">Claims</a> <!-- Dropdown trigger -->
                    <div class="dropdown-content">
                        <a href="/claims/search">Search Claims</a> <!-- Link to Search Claims -->
                        <a href="/claims/add">Add Claim</a> <!-- Link to Add Claim -->
                    </div>
                </li>
                <li><a href="/reports">Reports</a></li> <!-- Link to Reports -->
                <li class="Settings">
                    <a href="javascript:void(0)" class="dropbtn">Settings</a> <!-- Dropdown trigger -->
                    <div class="dropdown-content">
                        <a href="/general-settings">General Settings</a> <!-- Link to General Settings -->
                        <a href="/user-management">User Management</a> <!-- Link to User Management -->
                        <a href="/email-templates">Email Templates</a> <!-- Link to Email Templates -->
                    </div>
                </li>
                <li><a href="/help">Help</a></li> <!-- Link to Help -->
                <li><a href="/logout">Logout</a></li> <!-- Link to Logout -->
            </ul>
        </nav>
    </header>
    <main>
        <div class="container">
            <h2>Edit Claim</h2>

            <!-- Display Toast Notifications -->
            <div id="toast" class="toast"></div>

            <% if (typeof fileErrors !== 'undefined' && fileErrors.length > 0) { %>
                <div class="error-banner">
                    <h3>File Upload Errors:</h3>
                    <ul>
                        <% fileErrors.forEach(error => { %>
                            <li><%= error %></li>
                        <% }); %>
                    </ul>
                </div>
            <% } %>

            <form action="/claims/<%= claim._id %>?_method=PUT" method="POST" enctype="multipart/form-data">
                <div class="tab">
                    <div class="tab-row">
                        <button type="button" class="tablinks" id="customerInfoTab">Customer Information</button>
                        <button type="button" class="tablinks" id="vehicleInfoTab">Vehicle Information</button>
                        <button type="button" class="tablinks" id="claimDetailsTab">Claim Details</button>
                        <button type="button" class="tablinks" id="insuranceInfoTab">Insurance Information</button>
                    </div>
                    <div class="tab-row">
                        <button type="button" class="tablinks" id="thirdPartyInfoTab">Third Party Information</button>
                        <button type="button" class="tablinks" id="rentalPoliceInfoTab">Rental & Police Information</button>
                        <button type="button" class="tablinks" id="additionalCoverageTab">Additional Coverage</button>
                        <button type="button" class="tablinks" id="fileUploadsTab">File Uploads</button>
                    </div>
                </div>

                <!-- Tab content for Customer Information -->
                <div id="customerInfo" class="tabcontent">
                    <div class="claim-info">
                        <label for="customerName">Customer Name:</label>
                        <input type="text" id="customerName" name="customerName" value="<%= claim.customerName %>" required>
                        <% if (typeof errors !== 'undefined' && errors.customerName) { %>
                            <div class="error-message"><%= errors.customerName.msg %></div>
                        <% } %>

                        <label for="customerNumber">Customer Number:</label>
                        <input type="text" id="customerNumber" name="customerNumber" value="<%= claim.customerNumber %>">
                        <% if (typeof errors !== 'undefined' && errors.customerNumber) { %>
                            <div class="error-message"><%= errors.customerNumber.msg %></div>
                        <% } %>

                        <label for="customerEmail">Customer Email:</label>
                        <input type="email" id="customerEmail" name="customerEmail" value="<%= claim.customerEmail %>">
                        <% if (typeof errors !== 'undefined' && errors.customerEmail) { %>
                            <div class="error-message"><%= errors.customerEmail.msg %></div>
                        <% } %>

                        <label for="customerAddress">Customer Address:</label>
                        <input type="text" id="customerAddress" name="customerAddress" value="<%= claim.customerAddress %>">
                        <% if (typeof errors !== 'undefined' && errors.customerAddress) { %>
                            <div class="error-message"><%= errors.customerAddress.msg %></div>
                        <% } %>

                        <label for="customerDriversLicense">Customer Drivers License:</label>
                        <input type="text" id="customerDriversLicense" name="customerDriversLicense" value="<%= claim.customerDriversLicense %>">
                        <% if (typeof errors !== 'undefined' && errors.customerDriversLicense) { %>
                            <div class="error-message"><%= errors.customerDriversLicense.msg %></div>
                        <% } %>
                    </div>
                </div>

                <!-- Tab content for Vehicle Information -->
                <div id="vehicleInfo" class="tabcontent">
                    <div class="claim-info">
                        <label for="carMake">Car Make:</label>
                        <input type="text" id="carMake" name="carMake" value="<%= claim.carMake %>">
                        <% if (typeof errors !== 'undefined' && errors.carMake) { %>
                            <div class="error-message"><%= errors.carMake.msg %></div>
                        <% } %>

                        <label for="carModel">Car Model:</label>
                        <input type="text" id="carModel" name="carModel" value="<%= claim.carModel %>">
                        <% if (typeof errors !== 'undefined' && errors.carModel) { %>
                            <div class="error-message"><%= errors.carModel.msg %></div>
                        <% } %>

                        <label for="carYear">Car Year:</label>
                        <input type="text" id="carYear" name="carYear" value="<%= claim.carYear %>">
                        <% if (typeof errors !== 'undefined' && errors.carYear) { %>
                            <div class="error-message"><%= errors.carYear.msg %></div>
                        <% } %>

                        <label for="carColor">Car Color:</label>
                        <input type="text" id="carColor" name="carColor" value="<%= claim.carColor %>">
                        <% if (typeof errors !== 'undefined' && errors.carColor) { %>
                            <div class="error-message"><%= errors.carColor.msg %></div>
                        <% } %>

                        <label for="carVIN">Car VIN:</label>
                        <input type="text" id="carVIN" name="carVIN" value="<%= claim.carVIN %>">
                        <% if (typeof errors !== 'undefined' && errors.carVIN) { %>
                            <div class="error-message"><%= errors.carVIN.msg %></div>
                        <% } %>

                        <label for="vehicleOdometer">Vehicle Odometer:</label>
                        <input type="number" id="vehicleOdometer" name="vehicleOdometer" value="<%= claim.vehicleOdometer %>">
                        <% if (typeof errors !== 'undefined' && errors.vehicleOdometer) { %>
                            <div class="error-message"><%= errors.vehicleOdometer.msg %></div>
                        <% } %>

                        <label for="accidentDate">Accident Date:</label>
                        <input type="date" id="accidentDate" name="accidentDate" value="<%= claim.accidentDate ? new Date(claim.accidentDate).toISOString().split('T')[0] : '' %>">
                        <% if (typeof errors !== 'undefined' && errors.accidentDate) { %>
                            <div class="error-message"><%= errors.accidentDate.msg %></div>
                        <% } %>
                    </div>
                </div>

                <!-- Tab content for Claim Details -->
                <div id="claimDetails" class="tabcontent">
                    <div class="claim-info">
                        <label for="mva">MVA:</label>
                        <input type="text" id="mva" name="mva">
                        <span class="error-message" id="errorMVA"></span>

                        <label for="raNumber">RA Number:</label>
                        <input type="text" id="raNumber" name="raNumber">
                        <span class="error-message" id="errorRANumber"></span>

                        <label for="damagesTotal">Damages Total:</label>
                        <input type="text" id="damagesTotal" name="damagesTotal">
                        <span class="error-message" id="errorDamagesTotal"></span>

                        <label for="billable">Billable:</label>
                        <select id="billable" name="billable">
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                            <option value="n/a">N/A</option>
                            <option value="unknown">Unknown</option>
                        </select>
                        <span class="error-message" id="errorBillable"></span>

                        <label for="isRenterAtFault">Is Renter At Fault:</label>
                        <select id="isRenterAtFault" name="isRenterAtFault">
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                            <option value="n/a">N/A</option>
                            <option value="unknown">Unknown</option>
                        </select>
                        <span class="error-message" id="errorIsRenterAtFault"></span>

                        <label for="damageType">Damage Type:</label>
                        <div id="damageTypeContainer">
                            <% damageTypes.forEach(damageType => { %>
                            <label>
                                <input type="checkbox" name="damageType" value="<%= damageType._id %>" <%= claim.damageType && claim.damageType.includes(damageType._id.toString()) ? 'checked' : '' %>>
                                <%= damageType.name %>
                            </label>
                            <% }) %>
                        </div>
                        <label for="status">Status:</label>
                        <select id="status" name="status">
                            <% statuses.forEach(status => { %>
                            <option value="<%= status._id %>" <%= claim.status && claim.status.toString() === status._id.toString() ? 'selected' : '' %>><%= status.name %></option>
                            <% }) %>
                        </select>
                    </div>
                </div>

                <!-- Tab content for Insurance Information -->
                <div id="insuranceInfo" class="tabcontent">
                    <div class="claim-info">
                        <label for="insuranceCarrier">Insurance Carrier:</label>
                        <input type="text" id="insuranceCarrier" name="insuranceCarrier" value="<%= claim.insuranceCarrier %>">
                        <% if (typeof errors !== 'undefined' && errors.insuranceCarrier) { %>
                            <div class="error-message"><%= errors.insuranceCarrier.msg %></div>
                        <% } %>

                        <label for="insuranceAdjuster">Insurance Adjuster:</label>
                        <input type="text" id="insuranceAdjuster" name="insuranceAdjuster" value="<%= claim.insuranceAdjuster %>">
                        <% if (typeof errors !== 'undefined' && errors.insuranceAdjuster) { %>
                            <div class="error-message"><%= errors.insuranceAdjuster.msg %></div>
                        <% } %>

                        <label for="insuranceEmail">Insurance Email:</label>
                        <input type="email" id="insuranceEmail" name="insuranceEmail" value="<%= claim.insuranceEmail %>">
                        <% if (typeof errors !== 'undefined' && errors.insuranceEmail) { %>
                            <div class="error-message"><%= errors.insuranceEmail.msg %></div>
                        <% } %>

                        <label for="insurancePhoneNumber">Insurance Phone Number:</label>
                        <input type="text" id="insurancePhoneNumber" name="insurancePhoneNumber" value="<%= claim.insurancePhoneNumber %>">
                        <% if (typeof errors !== 'undefined' && errors.insurancePhoneNumber) { %>
                            <div class="error-message"><%= errors.insurancePhoneNumber.msg %></div>
                        <% } %>

                        <label for="insuranceFaxNumber">Insurance Fax Number:</label>
                        <input type="text" id="insuranceFaxNumber" name="insuranceFaxNumber" value="<%= claim.insuranceFaxNumber %>">
                        <% if (typeof errors !== 'undefined' && errors.insuranceFaxNumber) { %>
                            <div class="error-message"><%= errors.insuranceFaxNumber.msg %></div>
                        <% } %>

                        <label for="insuranceAddress">Insurance Address:</label>
                        <input type="text" id="insuranceAddress" name="insuranceAddress" value="<%= claim.insuranceAddress %>">
                        <% if (typeof errors !== 'undefined' && errors.insuranceAddress) { %>
                            <div class="error-message"><%= errors.insuranceAddress.msg %></div>
                        <% } %>

                        <label for="insurancePolicyNumber">Insurance Policy Number:</label>
                        <input type="text" id="insurancePolicyNumber" name="insurancePolicyNumber" value="<%= claim.insurancePolicyNumber %>">
                        <% if (typeof errors !== 'undefined' && errors.insurancePolicyNumber) { %>
                            <div class="error-message"><%= errors.insurancePolicyNumber.msg %></div>
                        <% } %>

                        <label for="insuranceClaimNumber">Insurance Claim Number:</label>
                        <input type="text" id="insuranceClaimNumber" name="insuranceClaimNumber" value="<%= claim.insuranceClaimNumber %>">
                        <% if (typeof errors !== 'undefined' && errors.insuranceClaimNumber) { %>
                            <div class="error-message"><%= errors.insuranceClaimNumber.msg %></div>
                        <% } %>
                    </div>
                </div>

                <!-- Tab content for Third Party Information -->
                <div id="thirdPartyInfo" class="tabcontent">
                    <div class="claim-info">
                        <label for="thirdPartyName">Third Party Name:</label>
                        <input type="text" id="thirdPartyName" name="thirdPartyName" value="<%= claim.thirdPartyName %>">
                        <% if (typeof errors !== 'undefined' && errors.thirdPartyName) { %>
                            <div class="error-message"><%= errors.thirdPartyName.msg %></div>
                        <% } %>

                        <label for="thirdPartyAddress">Third Party Address:</label>
                        <input type="text" id="thirdPartyAddress" name="thirdPartyAddress" value="<%= claim.thirdPartyAddress %>">
                        <% if (typeof errors !== 'undefined' && errors.thirdPartyAddress) { %>
                            <div class="error-message"><%= errors.thirdPartyAddress.msg %></div>
                        <% } %>

                        <label for="thirdPartyPhoneNumber">Third Party Phone Number:</label>
                        <input type="text" id="thirdPartyPhoneNumber" name="thirdPartyPhoneNumber" value="<%= claim.thirdPartyPhoneNumber %>">
                        <% if (typeof errors !== 'undefined' && errors.thirdPartyPhoneNumber) { %>
                            <div class="error-message"><%= errors.thirdPartyPhoneNumber.msg %></div>
                        <% } %>

                        <label for="thirdPartyInsuranceName">Third Party Insurance Name:</label>
                        <input type="text" id="thirdPartyInsuranceName" name="thirdPartyInsuranceName" value="<%= claim.thirdPartyInsuranceName %>">
                        <% if (typeof errors !== 'undefined' && errors.thirdPartyInsuranceName) { %>
                            <div class="error-message"><%= errors.thirdPartyInsuranceName.msg %></div>
                        <% } %>

                        <label for="thirdPartyAdjusterName">Third Party Adjuster Name:</label>
                        <input type="text" id="thirdPartyAdjusterName" name="thirdPartyAdjusterName" value="<%= claim.thirdPartyAdjusterName %>">
                        <% if (typeof errors !== 'undefined' && errors.thirdPartyAdjusterName) { %>
                            <div class="error-message"><%= errors.thirdPartyAdjusterName.msg %></div>
                        <% } %>

                        <label for="thirdPartyPolicyNumber">Third Party Policy Number:</label>
                        <input type="text" id="thirdPartyPolicyNumber" name="thirdPartyPolicyNumber" value="<%= claim.thirdPartyPolicyNumber %>">
                        <% if (typeof errors !== 'undefined' && errors.thirdPartyPolicyNumber) { %>
                            <div class="error-message"><%= errors.thirdPartyPolicyNumber.msg %></div>
                        <% } %>

                        <label for="thirdPartyClaimNumber">Third Party Claim Number:</label>
                        <input type="text" id="thirdPartyClaimNumber" name="thirdPartyClaimNumber" value="<%= claim.thirdPartyClaimNumber %>">
                        <% if (typeof errors !== 'undefined' && errors.thirdPartyClaimNumber) { %>
                            <div class="error-message"><%= errors.thirdPartyClaimNumber.msg %></div>
                        <% } %>
                    </div>
                </div>

                <!-- Tab content for Rental & Police Information -->
                <div id="rentalPoliceInfo" class="tabcontent">
                    <div class="claim-info">
                        <label for="rentingLocation">Renting Location:</label>
                        <select id="rentingLocation" name="rentingLocation">
                            <% if (typeof rentingLocations !== 'undefined' && rentingLocations.length > 0) { %>
                                <% rentingLocations.forEach(location => { %>
                                    <option value="<%= location._id %>" 
                                        <%= claim.rentingLocation && claim.rentingLocation.toString() === location._id.toString() ? 'selected' : '' %>>
                                        <%= location.name %>
                                    </option>
                                <% }); %>
                            <% } else { %>
                                <option value="">No locations available</option>
                            <% } %>
                        </select>
                        <% if (typeof errors !== 'undefined' && errors.rentingLocation) { %>
                            <div class="error"><%= errors.rentingLocation.msg %></div>
                        <% } %>
                        
                        <label for="policeDepartment">Police Department:</label>
                        <input type="text" id="policeDepartment" name="policeDepartment" value="<%= claim.policeDepartment %>">
                        <% if (typeof errors !== 'undefined' && errors.policeDepartment) { %>
                            <div class="error-message"><%= errors.policeDepartment.msg %></div>
                        <% } %>

                        <label for="policeReportNumber">Police Report Number:</label>
                        <input type="text" id="policeReportNumber" name="policeReportNumber" value="<%= claim.policeReportNumber %>">
                        <% if (typeof errors !== 'undefined' && errors.policeReportNumber) { %>
                            <div class="error-message"><%= errors.policeReportNumber.msg %></div>
                        <% } %>

                        <label for="claimCloseDate">Claim Close Date:</label>
                        <input type="date" id="claimCloseDate" name="claimCloseDate" value="<%= claim.claimCloseDate ? new Date(claim.claimCloseDate).toISOString().split('T')[0] : '' %>">
                        <% if (typeof errors !== 'undefined' && errors.claimCloseDate) { %>
                            <div class="error-message"><%= errors.claimCloseDate.msg %></div>
                        <% } %>
                    </div>
                </div>

                <!-- Tab content for Additional Coverage -->
                <div id="additionalCoverage" class="tabcontent">
                    <div class="claim-info">
                        <label for="rentersLiabilityInsurance">Was Renters Liability Insurance purchased?</label>
                        <select id="rentersLiabilityInsurance" name="rentersLiabilityInsurance">
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                            <option value="n/a">N/A</option>
                            <option value="unknown">Unknown</option>
                        </select>
                        <% if (typeof errors !== 'undefined' && errors.rentersLiabilityInsurance) { %>
                            <div class="error-message"><%= errors.rentersLiabilityInsurance.msg %></div>
                        <% } %>

                        <label for="lossDamageWaiver">Was Loss Damage Waiver purchased?</label>
                        <select id="lossDamageWaiver" name="lossDamageWaiver">
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                            <option value="n/a">N/A</option>
                            <option value="unknown">Unknown</option>
                        </select>
                        <% if (typeof errors !== 'undefined' && errors.lossDamageWaiver) { %>
                            <div class="error-message"><%= errors.lossDamageWaiver.msg %></div>
                        <% } %>
                    </div>
                </div>

                <!-- File Uploads Section -->
                <div id="fileUploads" class="tabcontent">
                    <div class="file-section">
                        <h3>Incident Reports</h3>
                        <input type="file" id="incidentReports" name="incidentReports" multiple>
                        <% if (typeof errors !== 'undefined' && errors.incidentReports) { %>
                            <div class="error-message"><%= errors.incidentReports.msg %></div>
                        <% } %>
                    </div>
                    <div class="file-section">
                        <h3>Correspondence</h3>
                        <input type="file" id="correspondence" name="correspondence" multiple>
                        <% if (typeof errors !== 'undefined' && errors.correspondence) { %>
                            <div class="error-message"><%= errors.correspondence.msg %></div>
                        <% } %>
                    </div>
                    <div class="file-section">
                        <h3>Rental Agreement</h3>
                        <input type="file" id="rentalAgreement" name="rentalAgreement" multiple>
                        <% if (typeof errors !== 'undefined' && errors.rentalAgreement) { %>
                            <div class="error-message"><%= errors.rentalAgreement.msg %></div>
                        <% } %>
                    </div>
                    <div class="file-section">
                        <h3>Police Report</h3>
                        <input type="file" id="policeReport" name="policeReport" multiple>
                        <% if (typeof errors !== 'undefined' && errors.policeReport) { %>
                            <div class="error-message"><%= errors.policeReport.msg %></div>
                        <% } %>
                    </div>
                    <div class="file-section">
                        <h3>Invoices</h3>
                        <input type="file" id="invoices" name="invoices" multiple>
                        <% if (typeof errors !== 'undefined' && errors.invoices) { %>
                            <div class="error-message"><%= errors.invoices.msg %></div>
                        <% } %>
                        <!-- Add input fields for invoice totals -->
                        <div id="invoiceTotalsContainer">
                            <% if (claim.invoiceTotals && claim.invoiceTotals.length > 0) { %>
                                <% claim.invoiceTotals.forEach(function(invoice, index) { %>
                                    <div class="invoice-total">
                                        <label for="invoiceTotal<%= index %>">Invoice Total for <%= invoice.fileName %>:</label>
                                        <input type="number" id="invoiceTotal<%= index %>" name="invoiceTotals[<%= index %>][total]" value="<%= invoice.total %>">
                                        <input type="hidden" name="invoiceTotals[<%= index %>][fileName]" value="<%= invoice.fileName %>">
                                    </div>
                                <% }); %>
                            <% } %>
                        </div>
                    </div>
                    <div class="file-section">
                        <h3>Photos</h3>
                        <input type="file" id="photos" name="photos" multiple>
                        <% if (typeof errors !== 'undefined' && errors.photos) { %>
                            <div class="error-message"><%= errors.photos.msg %></div>
                        <% } %>
                    </div>
                </div>

                <!-- Form submission buttons -->
                <div class="button-group">
                    <button type="submit" class="btn">Update Claim</button>
                    <a href="/claims/<%= claim._id %>" class="btn">Cancel</a>
                </div>
            </form>
        </div>
    </main>

    <script src="/js/claims-edit.js">
        document.querySelector('form').addEventListener('submit', function(e) {
    const fileInputs = document.querySelectorAll('input[type="file"]');
    let hasFiles = false;
    
    fileInputs.forEach(input => {
        if (input.files.length > 0) {
            hasFiles = true;
            console.log(`Files selected for ${input.name}:`, input.files);
        }
    });
    
    if (hasFiles) {
        console.log('Form submitted with files');
    }
});
    </script>
</body>
</html>