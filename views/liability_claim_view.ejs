<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Liability Claim - Budget Claims System</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <header>
        <!-- Logo and navigation -->
        <img src="/images/Budget_logo.svg" alt="Budget Logo" class="logo"> <!-- Company logo -->
        <h1>Budget Claims System</h1> <!-- Main heading -->
        <nav>
            <ul>
                <li><a href="/dashboard">Dashboard</a></li> <!-- Link to Dashboard -->
                <li class="Claims">
                    <a href="javascript:void(0)" class="dropbtn">Claims</a> <!-- Dropdown trigger -->
                    <div class="dropdown-content">
                        <a href="/claims/search">Search Claims</a> <!-- Link to Search Claims -->
                        <a href="/claims/add">Add Claim</a> <!-- Link to Add Claim -->
                    </div>
                </li>
                <li><a href="/reports">Reports</a></li> <!-- Link to Reports -->
                <li class="Settings">
                    <a href="javascript:void(0)" class="dropbtn">Settings</a> <!-- Dropdown trigger -->
                    <div class="dropdown-content">
                        <a href="/general-settings">General Settings</a> <!-- Link to General Settings -->
                        <a href="/user-management">User Management</a> <!-- Link to User Management -->
                        <a href="/email-templates">Email Templates</a> <!-- Link to Email Templates -->
                    </div>
                </li>
                <li><a href="/help">Help</a></li> <!-- Link to Help -->
                <li><a href="/logout">Logout</a></li> <!-- Link to Logout -->
            </ul>
        </nav>
    </header>
    <main>
        <div class="container">
            <h2>View Liability Claim</h2> <!-- Section heading -->

            <!-- Display claim information -->
            <div class="claim-info">
                <label>Claim Number:</label>
                <p><%= claim.claimNumber %></p>

                <label>MVA:</label>
                <p><%= claim.mva %></p>

                <label>Customer Name:</label>
                <p><%= claim.customerName %></p>

                <label>Customer Number:</label>
                <p><%= claim.customerNumber %></p>

                <label>Customer Email:</label>
                <p><%= claim.customerEmail %></p>

                <label>Customer Address:</label>
                <p><%= claim.customerAddress %></p>

                <label>Customer Drivers License:</label>
                <p><%= claim.customerDriversLicense %></p>

                <label>Car Make:</label>
                <p><%= claim.carMake %></p>

                <label>Car Model:</label>
                <p><%= claim.carModel %></p>

                <label>Car Year:</label>
                <p><%= claim.carYear %></p>

                <label>Car Color:</label>
                <p><%= claim.carColor %></p>

                <label>Car VIN:</label>
                <p><%= claim.carVIN %></p>

                <label>Accident Date:</label>
                <p><%= claim.accidentDate ? new Date(claim.accidentDate).toLocaleDateString() : '' %></p>

                <label>Billable:</label>
                <p><%= claim.billable ? 'Yes' : 'No' %></p>

                <label>Is Renter At Fault:</label>
                <p><%= claim.isRenterAtFault ? 'Yes' : 'No' %></p>

                <label>Damages Total:</label>
                <p><%= claim.damagesTotal %></p>

                <label>Body Shop Name:</label>
                <p><%= claim.bodyShopName %></p>

                <label>RA Number:</label>
                <p><%= claim.raNumber %></p>

                <label>Insurance Carrier:</label>
                <p><%= claim.insuranceCarrier %></p>

                <label>Insurance Adjuster:</label>
                <p><%= claim.insuranceAdjuster %></p>

                <label>Insurance Email:</label>
                <p><%= claim.insuranceEmail %></p>

                <label>Insurance Phone Number:</label>
                <p><%= claim.insurancePhoneNumber %></p>

                <label>Insurance Fax Number:</label>
                <p><%= claim.insuranceFaxNumber %></p>

                <label>Insurance Address:</label>
                <p><%= claim.insuranceAddress %></p>

                <label>Insurance Policy Number:</label>
                <p><%= claim.insurancePolicyNumber %></p>

                <label>Insurance Claim Number:</label>
                <p><%= claim.insuranceClaimNumber %></p>

                <label>Third Party Name:</label>
                <p><%= claim.thirdPartyName %></p>

                <label>Third Party Address:</label>
                <p><%= claim.thirdPartyAddress %></p>

                <label>Third Party Phone Number:</label>
                <p><%= claim.thirdPartyPhoneNumber %></p>

                <label>Third Party Insurance Name:</label>
                <p><%= claim.thirdPartyInsuranceName %></p>

                <label>Third Party Adjuster Name:</label>
                <p><%= claim.thirdPartyAdjusterName %></p>

                <label>Third Party Policy Number:</label>
                <p><%= claim.thirdPartyPolicyNumber %></p>

                <label>Third Party Claim Number:</label>
                <p><%= claim.thirdPartyClaimNumber %></p>

                <label>Renting Location:</label>
                <p><%= claim.rentingLocation ? claim.rentingLocation.name : 'N/A' %></p>

                <label>LDW Accepted:</label>
                <p><%= claim.ldwAccepted ? 'Yes' : 'No' %></p>

                <label>Police Department:</label>
                <p><%= claim.policeDepartment %></p>

                <label>Police Report Number:</label>
                <p><%= claim.policeReportNumber %></p>

                <label>Claim Close Date:</label>
                <p><%= claim.claimCloseDate ? new Date(claim.claimCloseDate).toLocaleDateString() : '' %></p>

                <label>Vehicle Odometer:</label>
                <p><%= claim.vehicleOdometer %></p>

                <label>Description:</label>
                <p><%= claim.description %></p>
                
                <label>Was Renters Liability Insurance purchased?</label>
                <p><%= claim.rentersLiabilityInsurance %></p>

                <label>Was Loss Damage Waiver purchased?</label>
                <p><%= claim.lossDamageWaiver %></p>

                <label>Damage Type:</label>
                <% if (claim.damageType) { %>
                    <% if (Array.isArray(claim.damageType)) { %>
                        <ul>
                            <% claim.damageType.forEach(type => { %>
                                <li><%= typeof type === 'object' ? type.name : type %></li>
                            <% }) %>
                        </ul>
                    <% } else { %>
                        <p><%= typeof claim.damageType === 'object' ? claim.damageType.name : claim.damageType %></p>
                    <% } %>
                <% } else { %>
                    <p>Not specified</p>
                <% } %>

                <label>Status:</label>
                <p><%= claim.status ? claim.status.name : 'Not specified' %></p>

                <label>Files:</label>
                <div class="files-section">              
                    <div class="files-grid">
                        <div class="file-section view-mode">
                            <h3>ðŸ“„ Incident Reports</h3>
                            <% if (claim.files && claim.files.incidentReports) { %>
                                <% claim.files.incidentReports.forEach(file => { %>
                                    <div class="file-item">
                                        <span class="file-name"><%= file %></span>
                                        <div class="file-actions">
                                            <button type="button" class="view-file" data-file="<%= file %>">View</button>
                                            <a href="/uploads/<%= file %>" class="download-file" download>Download</a>
                                        </div>
                                    </div>
                                <% }) %>
                            <% } %>
                        </div>

                        <div class="file-section view-mode">
                            <h3>ðŸ“‹ Correspondence</h3>
                            <% if (claim.files && claim.files.correspondence) { %>
                                <% claim.files.correspondence.forEach(file => { %>
                                    <div class="file-item">
                                        <span class="file-name"><%= file %></span>
                                        <div class="file-actions">
                                            <button type="button" class="view-file" data-file="<%= file %>">View</button>
                                            <a href="/uploads/<%= file %>" class="download-file" download>Download</a>
                                        </div>
                                    </div>
                                <% }) %>
                            <% } %>
                        </div>

                        <div class="file-section view-mode">
                            <h3>ðŸ“‹ Rental Agreement</h3>
                            <% if (claim.files && claim.files.rentalAgreement) { %>
                                <% claim.files.rentalAgreement.forEach(file => { %>
                                    <div class="file-item">
                                        <span class="file-name"><%= file %></span>
                                        <div class="file-actions">
                                            <button type="button" class="view-file" data-file="<%= file %>">View</button>
                                            <a href="/uploads/<%= file %>" class="download-file" download>Download</a>
                                        </div>
                                    </div>
                                <% }) %>
                            <% } %>
                        </div>

                        <div class="file-section view-mode">
                            <h3>ðŸ’° Police Report</h3>
                            <% if (claim.files && claim.files.policeReport) { %>
                                <% claim.files.policeReport.forEach(file => { %>
                                    <div class="file-item">
                                        <span class="file-name"><%= file %></span>
                                        <div class="file-actions">
                                            <button type="button" class="view-file" data-file="<%= file %>">View</button>
                                            <a href="/uploads/<%= file %>" class="download-file" download>Download</a>
                                        </div>
                                    </div>
                                <% }) %>
                            <% } %>
                        </div>

                        <div class="file-section view-mode">
                            <h3>ðŸ’° Invoices</h3>
                            <% if (claim.files && claim.files.invoices) { %>
                                <% claim.files.invoices.forEach(file => { %>
                                    <div class="file-item">
                                        <span class="file-name"><%= file %></span>
                                        <div class="file-actions">
                                            <button type="button" class="view-file" data-file="<%= file %>">View</button>
                                            <a href="/uploads/<%= file %>" class="download-file" download>Download</a>
                                        </div>
                                    </div>
                                <% }) %>
                            <% } %>
                        </div>

                        <div class="file-section view-mode">
                            <h3>ðŸ“¸ Photos</h3>
                            <% if (claim.files && claim.files.photos) { %>
                                <% claim.files.photos.forEach(file => { %>
                                    <div class="file-item">
                                        <span class="file-name"><%= file %></span>
                                        <div class="file-actions">
                                            <button type="button" class="view-file" data-file="<%= file %>">View</button>
                                            <a href="/uploads/<%= file %>" class="download-file" download>Download</a>
                                        </div>
                                    </div>
                                <% }) %>
                            <% } %>
                        </div>
                    </div>
                </div>

                <!-- Display Invoice Totals -->
                <label>Invoice Totals:</label>
                <div class="invoice-totals">
                    <% if (claim.invoiceTotals && claim.invoiceTotals.length > 0) { %>
                        <ul class="invoice-list">
                            <% claim.invoiceTotals.forEach(invoice => { %>
                                <li class="invoice-item" data-filename="<%= invoice.fileName %>">
                                    <span class="invoice-name"><%= invoice.fileName %></span>
                                    <div class="invoice-amount-container">
                                        <span class="invoice-amount">$<%= invoice.total.toFixed(2) %></span>
                                        <input type="number" 
                                               class="invoice-edit-input" 
                                               value="<%= invoice.total || 0 %>" 
                                               placeholder="$0.00"
                                               step="0.01" 
                                               min="0" 
                                               style="display: none;">
                                        <button class="btn btn-edit-invoice">Edit</button>
                                    </div>
                                </li>
                            <% }) %>
                        </ul>
                    <% } else { %>
                        <p>No invoices found</p>
                    <% } %>
                </div>

                <!-- Calculate and Display Admin Fee -->
                <%
                    let totalInvoices = claim.invoiceTotals?.reduce((sum, invoice) => sum + (invoice.total || 0), 0) || 0;
                    let adminFee = 0;
                    if (totalInvoices >= 100 && totalInvoices < 500) {
                        adminFee = 50;
                    } else if (totalInvoices >= 500 && totalInvoices < 1500) {
                        adminFee = 100;
                    } else if (totalInvoices >= 1500) {
                        adminFee = 150;
                    }
                %>
                <label>Admin Fee:</label>
                <p id="adminFeeAmount">$<%= adminFee.toFixed(2) %></p>

                <label>Notes:</label>
                <div class="notes-section">
                    <% if (claim.notes && claim.notes.length > 0) { %>
                        <div class="notes-list">
                            <% claim.notes.sort((a, b) => b.createdAt - a.createdAt).forEach(note => { %>
                                <div class="note-item">
                                    <div class="note-header">
                                        <span class="note-type"><%= note.type.charAt(0).toUpperCase() + note.type.slice(1) %></span>
                                        <% if (note.source) { %>
                                            <span class="note-source">from <%= note.source %></span>
                                        <% } %>
                                        <span class="note-date"><%= new Date(note.createdAt).toLocaleString() %></span>
                                    </div>
                                    <div class="note-content"><%= note.content %></div>
                                </div>
                            <% }) %>
                        </div>
                    <% } else { %>
                        <p>No notes available</p>
                    <% } %>
                </div>
            </div>
            <div class="button-group">
                <a href="/claims/liability/<%= claim._id %>/edit" class="btn">Edit Claim</a> <!-- Button to edit claim -->
                <a href="/claims/liability/<%= claim._id %>/export" class="btn">Export to PDF</a> <!-- Button to export claim to PDF -->
                <% if (originalClaimId) { %>
                    <a href="/claims/<%= originalClaimId %>" class="btn">Show Damage Claim</a> <!-- Button to view original claim -->
                <% } %>
                <a href="#" class="btn" data-action="email" data-claimid="<%= claim._id %>">Send Email</a> <!-- Button to send email -->
                <form action="/claims/liability/<%= claim._id %>?_method=DELETE" method="post" style="display: inline;"> <!-- Form to delete claim -->
                    <button type="submit" class="btn btn-delete">Delete Claim</button> <!-- Button to delete claim -->
                </form>
            </div>
        </div>
    </main>

    <div id="fileViewer" class="file-viewer">
        <div class="file-viewer-header">
            <span id="fileViewerTitle"></span>
            <button class="close-button" id="closeFileViewerBtn">&times;</button>
        </div>
        <div class="file-viewer-content">
            <iframe id="fileViewerFrame"></iframe>
        </div>
    </div>

    <script>
        const claimId = '<%= claim._id %>'; // Make claim ID available to JavaScript
    </script>
    <script src="/js/claim-view.js"></script>
</body>
</html> 