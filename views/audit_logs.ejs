<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"> <!-- Set the character encoding for the document -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Ensure proper rendering and touch zooming on mobile devices -->
    <title>Audit Logs - Budget Claims System</title> <!-- Title of the document -->
    <link rel="stylesheet" href="/css/styles.css"> <!-- Link to external CSS for styling -->
    <!-- Add datepicker CSS for filtering by date -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
    <header>
        <!-- Logo and navigation -->
        <img src="/images/Budget_logo.svg" alt="Budget Logo" class="logo"> <!-- Company logo -->
        <h1>Budget Claims System</h1> <!-- Main heading -->
        <nav>
            <ul>
                <li><a href="/dashboard">Dashboard</a></li> <!-- Link to Dashboard -->
                <li class="Claims">
                    <a href="javascript:void(0)" class="dropbtn">Claims</a> <!-- Dropdown trigger -->
                    <div class="dropdown-content">
                        <a href="/claims/search">Search Claims</a> <!-- Link to Search Claims -->
                        <a href="/claims/add">Add Claim</a> <!-- Link to Add Claim -->
                    </div>
                </li>
                <li><a href="/reports">Reports</a></li> <!-- Link to Reports -->
                <li class="Settings">
                    <a href="javascript:void(0)" class="dropbtn">Settings</a> <!-- Dropdown trigger -->
                    <div class="dropdown-content">
                        <a href="/general-settings">General Settings</a> <!-- Link to General Settings -->
                        <a href="/user-management">User Management</a> <!-- Link to User Management -->
                        <a href="/email-templates">Email Templates</a> <!-- Link to Email Templates -->
                    </div>
                </li>
                <li><a href="/help">Help</a></li> <!-- Link to Help -->
                <li><a href="/logout">Logout</a></li> <!-- Link to Logout -->
            </ul>
        </nav>
    </header>
    <main>
        <h2>Audit Logs</h2> <!-- Section heading -->

        <!-- Filter form -->
        <div class="filter-section">
            <h3>Filter Logs</h3>
            <form id="filter-form" action="/audit-logs" method="GET">
                <div class="form-group">
                    <label for="userId">User ID:</label>
                    <input type="text" id="userId" name="userId" value="<%= filters.userId %>" placeholder="Filter by user ID">
                </div>
                
                <div class="form-group">
                    <label for="action">Action:</label>
                    <select id="action" name="action">
                        <option value="">All Actions</option>
                        <% if (filters.uniqueActions && filters.uniqueActions.length) { %>
                            <% filters.uniqueActions.forEach(action => { %>
                                <option value="<%= action %>" <%= filters.action === action ? 'selected' : '' %>><%= action %></option>
                            <% }) %>
                        <% } %>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="startDate">Start Date:</label>
                    <input type="date" id="startDate" name="startDate" value="<%= filters.startDate %>" class="datepicker">
                </div>
                
                <div class="form-group">
                    <label for="endDate">End Date:</label>
                    <input type="date" id="endDate" name="endDate" value="<%= filters.endDate %>" class="datepicker">
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Apply Filters</button>
                    <button type="button" id="clearFilters" class="btn btn-secondary">Clear Filters</button>
                </div>
            </form>
        </div>

        <!-- Export options -->
        <div class="export-section">
            <h3>Export Logs</h3>
            <div class="export-buttons">
                <a href="/audit-logs/export/csv<%= Object.keys(filters).filter(key => filters[key] && key !== 'uniqueActions').map((key, index) => `${index === 0 ? '?' : '&'}${key}=${filters[key]}`).join('') %>" class="btn btn-export">Export as CSV</a>
                <a href="/audit-logs/export/excel<%= Object.keys(filters).filter(key => filters[key] && key !== 'uniqueActions').map((key, index) => `${index === 0 ? '?' : '&'}${key}=${filters[key]}`).join('') %>" class="btn btn-export">Export as Excel</a>
                <a href="/audit-logs/export/pdf<%= Object.keys(filters).filter(key => filters[key] && key !== 'uniqueActions').map((key, index) => `${index === 0 ? '?' : '&'}${key}=${filters[key]}`).join('') %>" class="btn btn-export">Export as PDF</a>
            </div>
        </div>

        <!-- Table to display audit logs -->
        <table>
            <thead>
                <tr>
                    <th>User</th> <!-- Table header for User -->
                    <th>Action</th> <!-- Table header for Action -->
                    <th>Details</th> <!-- Table header for Details -->
                    <th>Timestamp</th> <!-- Table header for Timestamp -->
                </tr>
            </thead>
            <tbody>
                <% if (logs && logs.length) { %> <!-- Check if logs are available -->
                    <% logs.forEach(log => { %> <!-- Iterate over each log -->
                        <tr>
                            <td><%= log.user && log.user.username ? log.user.username : 'Unknown' %></td> <!-- Display username safely -->
                            <td><%= log.action %></td> <!-- Display action -->
                            <td><%= log.details %></td> <!-- Display details -->
                            <td><%= new Date(log.timestamp).toLocaleString() %></td> <!-- Display timestamp -->
                        </tr>
                    <% }) %>
                <% } else { %>
                    <tr>
                        <td colspan="4">No audit logs found.</td> <!-- Message if no logs are found -->
                    </tr>
                <% } %>
            </tbody>
        </table>

        <!-- Pagination controls -->
        <% if (pagination && pagination.totalPages > 1) { %>
            <div class="pagination">
                <% if (pagination.page > 1) { %>
                    <a href="/audit-logs?page=<%= pagination.page - 1 %><%= Object.keys(filters).filter(key => filters[key] && key !== 'uniqueActions').map(key => `&${key}=${filters[key]}`).join('') %>&limit=<%= pagination.limit %>" class="btn btn-pagination">&laquo; Previous</a>
                <% } %>
                
                <% 
                // Calculate range of page numbers to show
                let startPage = Math.max(1, pagination.page - 2);
                let endPage = Math.min(pagination.totalPages, pagination.page + 2);
                
                // Show first page if not in range
                if (startPage > 1) { %>
                    <a href="/audit-logs?page=1<%= Object.keys(filters).filter(key => filters[key] && key !== 'uniqueActions').map(key => `&${key}=${filters[key]}`).join('') %>&limit=<%= pagination.limit %>" class="btn btn-pagination">1</a>
                    <% if (startPage > 2) { %><span class="pagination-ellipsis">...</span><% } %>
                <% } %>
                
                <% // Display page numbers
                for (let i = startPage; i <= endPage; i++) { %>
                    <a href="/audit-logs?page=<%= i %><%= Object.keys(filters).filter(key => filters[key] && key !== 'uniqueActions').map(key => `&${key}=${filters[key]}`).join('') %>&limit=<%= pagination.limit %>" 
                       class="btn btn-pagination <%= i === pagination.page ? 'btn-pagination-active' : '' %>"><%= i %></a>
                <% } %>
                
                <% // Show last page if not in range
                if (endPage < pagination.totalPages) { %>
                    <% if (endPage < pagination.totalPages - 1) { %><span class="pagination-ellipsis">...</span><% } %>
                    <a href="/audit-logs?page=<%= pagination.totalPages %><%= Object.keys(filters).filter(key => filters[key] && key !== 'uniqueActions').map(key => `&${key}=${filters[key]}`).join('') %>&limit=<%= pagination.limit %>" class="btn btn-pagination"><%= pagination.totalPages %></a>
                <% } %>
                
                <% if (pagination.page < pagination.totalPages) { %>
                    <a href="/audit-logs?page=<%= pagination.page + 1 %><%= Object.keys(filters).filter(key => filters[key] && key !== 'uniqueActions').map(key => `&${key}=${filters[key]}`).join('') %>&limit=<%= pagination.limit %>" class="btn btn-pagination">Next &raquo;</a>
                <% } %>
                
                <span class="pagination-info">Page <%= pagination.page %> of <%= pagination.totalPages %> (Total: <%= pagination.totalLogs %> logs)</span>
            </div>
        <% } %>
    </main>

    <!-- Add JavaScript for datepicker and filter functionality -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        // Initialize datepickers
        flatpickr('.datepicker', {
            dateFormat: "Y-m-d",
            allowInput: true
        });
        
        // Clear filters button functionality
        document.getElementById('clearFilters').addEventListener('click', function() {
            document.getElementById('userId').value = '';
            document.getElementById('action').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('filter-form').submit();
        });
    </script>
</body>
</html>
