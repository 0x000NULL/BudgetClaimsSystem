<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Claim - Budget Claims System</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <header>
        <!-- Logo and navigation -->
        <img src="/images/Budget_logo.svg" alt="Budget Logo" class="logo"> <!-- Company logo -->
        <h1>Budget Claims System</h1> <!-- Main heading -->
        <nav>
            <ul>
                <li><a href="/dashboard">Dashboard</a></li> <!-- Link to Dashboard -->
                <li class="Claims">
                    <a href="javascript:void(0)" class="dropbtn">Claims</a> <!-- Dropdown trigger -->
                    <div class="dropdown-content">
                        <a href="/claims/search">Search Claims</a> <!-- Link to Search Claims -->
                        <a href="/claims/add">Add Claim</a> <!-- Link to Add Claim -->
                    </div>
                </li>
                <li><a href="/reports">Reports</a></li> <!-- Link to Reports -->
                <li class="Settings">
                    <a href="javascript:void(0)" class="dropbtn">Settings</a> <!-- Dropdown trigger -->
                    <div class="dropdown-content">
                        <a href="/general-settings">General Settings</a> <!-- Link to General Settings -->
                        <a href="/user-management">User Management</a> <!-- Link to User Management -->
                        <a href="/email-templates">Email Templates</a> <!-- Link to Email Templates -->
                    </div>
                </li>
                <li><a href="/help">Help</a></li> <!-- Link to Help -->
                <li><a href="/logout">Logout</a></li> <!-- Link to Logout -->
            </ul>
        </nav>
    </header>
    <main>
        <div class="container">
            <h2>View Claim</h2> <!-- Section heading -->

            <!-- Display claim information -->
            <div class="claim-info">
                <label>MVA:</label>
                <p><%= claim.mva %></p>

                <label>Customer Name:</label>
                <p><%= claim.customerName %></p>

                <label>Customer Number:</label>
                <p><%= claim.customerNumber %></p>

                <label>Customer Email:</label>
                <p><%= claim.customerEmail %></p>

                <label>Customer Address:</label>
                <p><%= claim.customerAddress %></p>

                <label>Customer Drivers License:</label>
                <p><%= claim.customerDriversLicense %></p>

                <label>Car Make:</label>
                <p><%= claim.carMake %></p>

                <label>Car Model:</label>
                <p><%= claim.carModel %></p>

                <label>Car Year:</label>
                <p><%= claim.carYear %></p>

                <label>Car Color:</label>
                <p><%= claim.carColor %></p>

                <label>Car VIN:</label>
                <p><%= claim.carVIN %></p>

                <label>Accident Date:</label>
                <p><%= claim.accidentDate ? new Date(claim.accidentDate).toLocaleDateString() : '' %></p>

                <label>Billable:</label>
                <p><%= claim.billable ? 'Yes' : 'No' %></p>

                <label>Is Renter At Fault:</label>
                <p><%= claim.isRenterAtFault ? 'Yes' : 'No' %></p>

                <label>Damages Total:</label>
                <p><%= claim.damagesTotal %></p>

                <label>Body Shop Name:</label>
                <p><%= claim.bodyShopName %></p>

                <label>RA Number:</label>
                <p><%= claim.raNumber %></p>

                <label>Insurance Carrier:</label>
                <p><%= claim.insuranceCarrier %></p>

                <label>Insurance Adjuster:</label>
                <p><%= claim.insuranceAdjuster %></p>

                <label>Insurance Email:</label>
                <p><%= claim.insuranceEmail %></p>

                <label>Insurance Phone Number:</label>
                <p><%= claim.insurancePhoneNumber %></p>

                <label>Insurance Fax Number:</label>
                <p><%= claim.insuranceFaxNumber %></p>

                <label>Insurance Address:</label>
                <p><%= claim.insuranceAddress %></p>

                <label>Insurance Policy Number:</label>
                <p><%= claim.insurancePolicyNumber %></p>

                <label>Insurance Claim Number:</label>
                <p><%= claim.insuranceClaimNumber %></p>

                <label>Third Party Name:</label>
                <p><%= claim.thirdPartyName %></p>

                <label>Third Party Address:</label>
                <p><%= claim.thirdPartyAddress %></p>

                <label>Third Party Phone Number:</label>
                <p><%= claim.thirdPartyPhoneNumber %></p>

                <label>Third Party Insurance Name:</label>
                <p><%= claim.thirdPartyInsuranceName %></p>

                <label>Third Party Adjuster Name:</label>
                <p><%= claim.thirdPartyAdjusterName %></p>

                <label>Third Party Policy Number:</label>
                <p><%= claim.thirdPartyPolicyNumber %></p>

                <label>Third Party Claim Number:</label>
                <p><%= claim.thirdPartyClaimNumber %></p>

                <label>Renting Location:</label>
                <p><%= claim.rentingLocation ? claim.rentingLocation.name : 'N/A' %></p> <!-- Display the name of the renting location -->

                <label>LDW Accepted:</label>
                <p><%= claim.ldwAccepted ? 'Yes' : 'No' %></p>

                <label>Police Department:</label>
                <p><%= claim.policeDepartment %></p>

                <label>Police Report Number:</label>
                <p><%= claim.policeReportNumber %></p>

                <label>Claim Close Date:</label>
                <p><%= claim.claimCloseDate ? new Date(claim.claimCloseDate).toLocaleDateString() : '' %></p>

                <label>Vehicle Odometer:</label>
                <p><%= claim.vehicleOdometer %></p>

                <label>Description:</label>
                <p><%= claim.description %></p>
                
                <label>Was Renters Liability Insurance purchased?</label>
                <p><%= claim.rentersLiabilityInsurance %></p>

                <label>Was Loss Damage Waiver purchased?</label>
                <p><%= claim.lossDamageWaiver %></p>

                <label>Damage Type:</label>
                <ul>
                    <% claim.damageType.forEach(type => { %>
                        <li><%= type %></li>
                    <% }) %>
                </ul>

                <label>Status:</label>
                <p><%= claim.status %></p>

                <label>Files:</label>
                <div class="files-section">
                    <% const fileCategories = [
                        { title: 'Incident Reports', files: claim.files.incidentReports || [], icon: 'üìÑ' },
                        { title: 'Correspondence', files: claim.files.correspondence || [], icon: '‚úâÔ∏è' },
                        { title: 'Rental Agreement', files: claim.files.rentalAgreement || [], icon: 'üìù' },
                        { title: 'Police Report', files: claim.files.policeReport || [], icon: 'üëÆ' },
                        { title: 'Invoices', files: claim.files.invoices || [], icon: 'üí∞' },
                        { title: 'Photos', files: claim.files.photos || [], icon: 'üì∏' }
                    ]; %>
                    
                    <div class="file-categories">
                        <% fileCategories.forEach(category => { %>
                            <div class="file-category">
                                <h4><%= category.icon %> <%= category.title %></h4>
                                <div class="file-list">
                                    <% if (category.files.length > 0) { %>
                                        <% category.files.forEach(file => { %>
                                            <div class="file-item">
                                                <a href="#" 
                                                   onclick="viewFileInline(event, '/uploads/<%= file %>')"
                                                   class="file-link"
                                                   data-filename="<%= file %>">
                                                    <%= file.substring(file.lastIndexOf('/') + 1) %>
                                                </a>
                                                <div class="file-actions">
                                                    <button onclick="downloadFile('/uploads/<%= file %>')" 
                                                            class="btn-icon" 
                                                            title="Download">
                                                        ‚¨áÔ∏è
                                                    </button>
                                                </div>
                                            </div>
                                        <% }) %>
                                    <% } else { %>
                                        <p class="no-files">No files uploaded</p>
                                    <% } %>
                                </div>
                            </div>
                        <% }) %>
                    </div>

                    <div id="file-viewer" class="file-viewer">
                        <div class="file-viewer-header">
                            <span id="current-file-name"></span>
                            <button onclick="closeFileViewer()" class="close-button">√ó</button>
                        </div>
                        <div class="file-viewer-content">
                            <div id="file-content"></div>
                        </div>
                    </div>
                </div>

                <!-- Display Invoice Totals -->
                <label>Invoice Totals:</label>
                <ul>
                    <% if (claim.invoiceTotals && claim.invoiceTotals.length > 0) { %>
                        <% claim.invoiceTotals.forEach(invoice => { %>
                            <li><%= invoice.fileName %>: $<%= invoice.total.toFixed(2) %></li>
                        <% }) %>
                    <% } else { %>
                        <li>No invoices found</li>
                    <% } %>
                </ul>

                <!-- Calculate and Display Admin Fee -->
                <%
                    let totalInvoices = claim.invoiceTotals?.reduce((sum, invoice) => sum + (invoice.total || 0), 0) || 0;
                    let adminFee = 0;
                    if (totalInvoices >= 100 && totalInvoices < 500) {
                        adminFee = 50;
                    } else if (totalInvoices >= 500 && totalInvoices < 1500) {
                        adminFee = 100;
                    } else if (totalInvoices >= 1500) {
                        adminFee = 150;
                    }
                %>
                <label>Admin Fee:</label>
                <p>$<%= adminFee.toFixed(2) %></p>
            </div>
            <div class="button-group">
                <a href="/claims/<%= claim._id %>/edit" class="btn">Edit Claim</a> <!-- Button to edit claim -->
                <a href="/claims/<%= claim._id %>/export" class="btn">Export to PDF</a> <!-- Button to export claim to PDF -->
                <a href="#" class="btn" onclick="openEmailForm('<%= claim._id %>')">Send Email</a> <!-- Button to send email -->
                <form action="/claims/<%= claim._id %>?_method=DELETE" method="post" style="display: inline;"> <!-- Form to delete claim -->
                    <button type="submit" class="btn btn-delete">Delete Claim</button> <!-- Button to delete claim -->
                </form>
            </div>
        </div>
    </main>

    <script src="/js/claim-view.js"></script>
</body>
</html>
