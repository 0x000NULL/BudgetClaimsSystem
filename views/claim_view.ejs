<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"> <!-- Set the character encoding for the document -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Ensure proper rendering and touch zooming on mobile devices -->
    <title>View Claim - Budget Claims System</title> <!-- Title of the document -->
    <link rel="stylesheet" href="/css/styles.css"> <!-- Link to external CSS file for styling -->
    <style>
        .btn {
            display: inline-block;
            padding: 8px 12px;
            margin: 5px;
            background-color: #007bff;
            color: white;
            text-align: center;
            text-decoration: none;
            border-radius: 4px;
        }

        .btn:hover {
            background-color: #0056b3;
        }

        .btn-delete {
            background-color: red;
        }

        .btn-delete:hover {
            background-color: darkred;
        }

        .container {
            max-width: 800px;
            margin: auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .claim-info {
            margin-bottom: 20px;
        }

        .claim-info label {
            font-weight: bold;
        }

        .claim-info p {
            margin: 5px 0 15px 0;
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .file-viewer {
            width: 100%;
            height: 500px;
            border: 1px solid #ddd;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <header>
        <!-- Logo and navigation -->
        <img src="/images/Budget_logo.svg" alt="Budget Logo" class="logo"> <!-- Company logo -->
        <h1>Budget Claims System</h1> <!-- Main heading -->
        <nav>
            <ul>
                <li><a href="/dashboard">Dashboard</a></li> <!-- Link to Dashboard -->
                <li class="Claims">
                    <a href="javascript:void(0)" class="dropbtn">Claims</a> <!-- Dropdown trigger -->
                    <div class="dropdown-content">
                        <a href="/claims/search">Search Claims</a> <!-- Link to Search Claims -->
                        <a href="/claims/add">Add Claim</a> <!-- Link to Add Claim -->
                    </div>
                </li>
                <li><a href="/reports">Reports</a></li> <!-- Link to Reports -->
                <li class="Settings">
                    <a href="javascript:void(0)" class="dropbtn">Settings</a> <!-- Dropdown trigger -->
                    <div class="dropdown-content">
                        <a href="/user-management">User Management</a> <!-- Link to User Management -->
                        <a href="/email-templates">Email Templates</a> <!-- Link to Email Templates -->
                    </div>
                </li>
                <li><a href="/help">Help</a></li> <!-- Link to Help -->
                <li><a href="/logout">Logout</a></li> <!-- Link to Logout -->
            </ul>
        </nav>
    </header>
    <main>
        <div class="container">
            <h2>View Claim</h2> <!-- Section heading -->

            <!-- Display claim information -->
            <div class="claim-info">
                <label>MVA:</label>
                <p><%= claim.mva %></p>

                <label>Customer Name:</label>
                <p><%= claim.customerName %></p>

                <label>Customer Number:</label>
                <p><%= claim.customerNumber %></p>

                <label>Customer Email:</label>
                <p><%= claim.customerEmail %></p>

                <label>Customer Address:</label>
                <p><%= claim.customerAddress %></p>

                <label>Customer Drivers License:</label>
                <p><%= claim.customerDriversLicense %></p>

                <label>Car Make:</label>
                <p><%= claim.carMake %></p>

                <label>Car Model:</label>
                <p><%= claim.carModel %></p>

                <label>Car Year:</label>
                <p><%= claim.carYear %></p>

                <label>Car Color:</label>
                <p><%= claim.carColor %></p>

                <label>Car VIN:</label>
                <p><%= claim.carVIN %></p>

                <label>Accident Date:</label>
                <p><%= claim.accidentDate ? new Date(claim.accidentDate).toLocaleDateString() : '' %></p>

                <label>Billable:</label>
                <p><%= claim.billable ? 'Yes' : 'No' %></p>

                <label>Is Renter At Fault:</label>
                <p><%= claim.isRenterAtFault ? 'Yes' : 'No' %></p>

                <label>Damages Total:</label>
                <p><%= claim.damagesTotal %></p>

                <label>Body Shop Name:</label>
                <p><%= claim.bodyShopName %></p>

                <label>RA Number:</label>
                <p><%= claim.raNumber %></p>

                <label>Insurance Carrier:</label>
                <p><%= claim.insuranceCarrier %></p>

                <label>Insurance Adjuster:</label>
                <p><%= claim.insuranceAdjuster %></p>

                <label>Insurance Email:</label>
                <p><%= claim.insuranceEmail %></p>

                <label>Insurance Phone Number:</label>
                <p><%= claim.insurancePhoneNumber %></p>

                <label>Insurance Fax Number:</label>
                <p><%= claim.insuranceFaxNumber %></p>

                <label>Insurance Address:</label>
                <p><%= claim.insuranceAddress %></p>

                <label>Insurance Policy Number:</label>
                <p><%= claim.insurancePolicyNumber %></p>

                <label>Insurance Claim Number:</label>
                <p><%= claim.insuranceClaimNumber %></p>

                <label>Third Party Name:</label>
                <p><%= claim.thirdPartyName %></p>

                <label>Third Party Address:</label>
                <p><%= claim.thirdPartyAddress %></p>

                <label>Third Party Phone Number:</label>
                <p><%= claim.thirdPartyPhoneNumber %></p>

                <label>Third Party Insurance Name:</label>
                <p><%= claim.thirdPartyInsuranceName %></p>

                <label>Third Party Adjuster Name:</label>
                <p><%= claim.thirdPartyAdjusterName %></p>

                <label>Third Party Policy Number:</label>
                <p><%= claim.thirdPartyPolicyNumber %></p>

                <label>Third Party Claim Number:</label>
                <p><%= claim.thirdPartyClaimNumber %></p>

                <label>Renting Location:</label>
                <p><%= claim.rentingLocation %></p>

                <label>LDW Accepted:</label>
                <p><%= claim.ldwAccepted ? 'Yes' : 'No' %></p>

                <label>Police Department:</label>
                <p><%= claim.policeDepartment %></p>

                <label>Police Report Number:</label>
                <p><%= claim.policeReportNumber %></p>

                <label>Claim Close Date:</label>
                <p><%= claim.claimCloseDate ? new Date(claim.claimCloseDate).toLocaleDateString() : '' %></p>

                <label>Vehicle Odometer:</label>
                <p><%= claim.vehicleOdometer %></p>

                <label>Description:</label>
                <p><%= claim.description %></p>

                <!-- New fields for Renters Liability Insurance and Loss Damage Waiver -->
                <label>Was Renters Liability Insurance purchased?</label>
                <p><%= claim.rentersLiabilityInsurance %></p>

                <label>Was Loss Damage Waiver purchased?</label>
                <p><%= claim.lossDamageWaiver %></p>

                <label>Damage Type:</label>
                <ul>
                    <% claim.damageType.forEach(type => { %>
                        <li><%= type %></li>
                    <% }) %>
                </ul>

                <label>Status:</label>
                <p><%= claim.status %></p>

                <label>Files:</label>
                <ul>
                    <% const fileCategories = [
                        { title: 'Incident Reports', files: claim.files.incidentReports || [] },
                        { title: 'Correspondence', files: claim.files.correspondence || [] },
                        { title: 'Rental Agreement', files: claim.files.rentalAgreement || [] },
                        { title: 'Police Report', files: claim.files.policeReport || [] },
                        { title: 'Invoices', files: claim.files.invoices || [] },
                        { title: 'Photos', files: claim.files.photos || [] }
                    ]; %>
                    <% fileCategories.forEach(category => { %>
                        <h4><%= category.title %>:</h4>
                        <ul>
                            <% category.files.forEach(file => { %>
                                <li><a href="#" onclick="viewFileInline(event, '/uploads/<%= file %>')"><%= file %></a></li>
                            <% }) %>
                        </ul>
                    <% }) %>
                </ul>

                <!-- Display Invoice Totals -->
                <label>Invoice Totals:</label>
                <ul>
                    <% claim.invoiceTotals.forEach(invoice => { %>
                        <li><%= invoice.fileName %>: $<%= invoice.total.toFixed(2) %></li>
                    <% }) %>
                </ul>

                <!-- Calculate and Display Admin Fee -->
                <%
                    let totalInvoices = claim.invoiceTotals.reduce((sum, invoice) => sum + invoice.total, 0);
                    let adminFee = 0;
                    if (totalInvoices >= 100 && totalInvoices < 500) {
                        adminFee = 50;
                    } else if (totalInvoices >= 500 && totalInvoices < 1500) {
                        adminFee = 100;
                    } else if (totalInvoices >= 1500) {
                        adminFee = 150;
                    }
                %>
                <label>Admin Fee:</label>
                <p>$<%= adminFee.toFixed(2) %></p>
            </div>
            <div class="button-group">
                <a href="/claims/<%= claim._id %>/edit" class="btn">Edit Claim</a> <!-- Button to edit claim -->
                <a href="/claims/<%= claim._id %>/export" class="btn">Export to PDF</a> <!-- Button to export claim to PDF -->
                <a href="#" class="btn" onclick="openEmailForm('<%= claim._id %>')">Send Email</a> <!-- Button to send email -->
                <form action="/claims/<%= claim._id %>?_method=DELETE" method="post" style="display: inline;"> <!-- Form to delete claim -->
                    <button type="submit" class="btn btn-delete">Delete Claim</button> <!-- Button to delete claim -->
                </form>
            </div>

            <div id="file-viewer" class="file-viewer" style="display: none;">
                <embed src="" id="inline-file" width="100%" height="100%">
            </div>
        </div>
    </main>

    <script>
        function openEmailForm(claimId) {
            const url = `/email/form/${claimId}`;
            const windowName = "EmailForm";
            const windowFeatures = "width=600,height=600";
            window.open(url, windowName, windowFeatures); // Open email form in a new window
        }

        function viewFileInline(event, filePath) {
            event.preventDefault();
            const viewer = document.getElementById('file-viewer');
            const embed = document.getElementById('inline-file');
            embed.src = filePath;
            viewer.style.display = 'block';
        }
    </script>
</body>
</html>
